version: 2

# =============================================================================
# S3 EXTERNAL SOURCES (for production cloud deployment)
# =============================================================================
# These sources define external Parquet files stored on S3-compatible storage.
# They are used when running dbt with the 'prod' target.
#
# Usage:
#   dbt run --target prod
#
# Prerequisites:
#   - S3_ACCESS_KEY_ID, S3_SECRET_ACCESS_KEY environment variables
#   - S3_BUCKET, S3_PREFIX environment variables
#   - Data loaded via ingestion scripts with USE_S3_STORAGE=true
#
# Note: Uses default values for env vars to allow parsing in dev mode.
# =============================================================================

sources:
  # =============================================================================
  # RAW MARKET DATA (Parquet files on S3)
  # =============================================================================
  - name: raw_s3
    description: Raw market data stored as Parquet files on S3-compatible storage
    meta:
      external_location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/{name}.parquet"
    tables:
      - name: raw_prices
        description: Historical price data for equities/ETFs (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/raw_prices.parquet"
          file_format: parquet

      - name: raw_benchmark_prices
        description: Benchmark (S&P 500) price data (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/raw_benchmark_prices.parquet"
          file_format: parquet

      - name: raw_treasury_yields
        description: Treasury yield curve data from FRED (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/raw_treasury_yields.parquet"
          file_format: parquet

      - name: raw_fund_metadata
        description: Fund metadata from Yahoo Finance API (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/raw_fund_metadata.parquet"
          file_format: parquet

      - name: raw_analyst_targets
        description: Analyst price targets from Yahoo Finance API (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/raw_analyst_targets.parquet"
          file_format: parquet

  # =============================================================================
  # POSTGRES REPLICATED DATA (Parquet files on S3)
  # =============================================================================
  - name: postgres_s3
    description: Replicated tables from Postgres stored as Parquet files on S3
    tables:
      - name: pg_portfolio
        description: Portfolio/account ownership (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_portfolio.parquet"
          file_format: parquet

      - name: pg_security_registry
        description: Canonical security identity (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_security_registry.parquet"
          file_format: parquet

      - name: pg_security_identifier
        description: Multiple identifiers per security (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_security_identifier.parquet"
          file_format: parquet

      - name: pg_equity_details
        description: Equity/ETF subtype details (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_equity_details.parquet"
          file_format: parquet

      - name: pg_bond_details
        description: Bond subtype details (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_bond_details.parquet"
          file_format: parquet

      - name: pg_transaction_ledger
        description: Append-only transaction ledger (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_transaction_ledger.parquet"
          file_format: parquet

      - name: pg_position_current
        description: Current positions (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_position_current.parquet"
          file_format: parquet

      - name: pg_cash_balance
        description: Cash balances per portfolio per currency (Parquet on S3)
        external:
          location: "s3://{{ env_var('S3_BUCKET', 'placeholder-bucket') }}/{{ env_var('S3_PREFIX', 'portfolio-analytics') }}/raw/pg_cash_balance.parquet"
          file_format: parquet
